<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì£¼ì‹ ì‹œë®¬ë ˆì´í„° ë½‘ê¸° ì‹œìŠ¤í…œ</title>
  <style>
/* ë² ì´ìŠ¤ ìŠ¤íƒ€ì¼ */
body {
  background: linear-gradient(120deg, #eef2f3, #8e9eab);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 20px;
  display: flex;
  justify-content: center;
  animation: fadeInBody 1.2s ease;
}

@keyframes fadeInBody {
  from { opacity: 0; transform: scale(1.02); }
  to { opacity: 1; transform: scale(1); }
}

#app {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  padding: 30px 40px;
  width: 1200px;
  transition: box-shadow 0.4s ease, transform 0.4s ease;
}
#app:hover {
  transform: scale(1.002);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.18);
}

/* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
.login-container {
  text-align: center;
  padding: 50px 20px;
}

.login-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 20px;
  background: linear-gradient(to right, #0052D4, #6FB1FC);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.login-subtitle {
  font-size: 1.2rem;
  color: #666;
  margin-bottom: 40px;
}

.google-login-btn {
  background: #4285f4;
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

.google-login-btn:hover {
  background: #3367d6;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
}

/* ì‚¬ìš©ì ì •ë³´ í‘œì‹œ */
.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  padding: 10px 15px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid #4364F7;
}

.user-name {
  font-weight: 600;
  color: #333;
  flex: 1;
}

.logout-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.3s ease;
}

.logout-btn:hover {
  background: #c82333;
}

h1 {
  text-align: center;
  margin-bottom: 15px;
  font-weight: 700;
  letter-spacing: 1.5px;
  font-size: 2.2rem;
  background: linear-gradient(to right, #0052D4, #6FB1FC);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  color: transparent;
  display: inline-block;
}

#timer {
  text-align: center;
  font-size: 1.1rem;
  color: #555;
  margin-bottom: 20px;
  font-weight: 600;
  letter-spacing: 1px;
  background: rgba(255, 255, 255, 0.6);
  padding: 8px 16px;
  border-radius: 12px;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
}

.main-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 15px;
}

.capital-display {
  font-weight: 600;
  font-size: 1.2rem;
  color: #444;
}

.gacha-container {
  text-align: center;
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

#gachaBtn {
  background: linear-gradient(45deg, #00c851, #007e33);
  border: none;
  color: white;
  padding: 12px 24px;
  border-radius: 20px;
  cursor: pointer;
  font-weight: 700;
  font-size: 1.1rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 200, 81, 0.4);
  animation: gachaGlow 2s infinite alternate;
}

@keyframes gachaGlow {
  from { box-shadow: 0 4px 15px rgba(0, 200, 81, 0.4); }
  to { box-shadow: 0 6px 20px rgba(0, 200, 81, 0.6); }
}

#gachaBtn:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(0, 200, 81, 0.6);
}

#gachaBtn:disabled {
  background: #ccc;
  cursor: not-allowed;
  animation: none;
  box-shadow: none;
}

.ticket-display {
  font-weight: 600;
  font-size: 1rem;
  color: #28a745;
  background: rgba(40, 167, 69, 0.1);
  padding: 8px 16px;
  border-radius: 12px;
  border: 2px solid #28a745;
}

/* ê±°ë˜ ë²„íŠ¼ */
.trade-btn {
  background: linear-gradient(45deg, #ff6b35, #f7931e);
  border: none;
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
}

.trade-btn:hover {
  background: linear-gradient(45deg, #f7931e, #ff6b35);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
}

.sections-container {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
}

.active-stocks, .inventory {
  flex: 1;
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.section-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #333;
  margin-bottom: 15px;
  text-align: center;
  padding-bottom: 8px;
  border-bottom: 2px solid #4364F7;
}

.inventory-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.inventory-count {
  font-size: 1rem;
  font-weight: 600;
  color: #666;
  background: rgba(67, 100, 247, 0.1);
  padding: 4px 12px;
  border-radius: 12px;
  border: 1px solid rgba(67, 100, 247, 0.3);
}

table {
  width: 100%;
  border-collapse: collapse;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 20px;
}

thead {
  background: linear-gradient(90deg, #0052D4, #4364F7, #6FB1FC);
  color: white;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

th, td {
  padding: 10px 8px;
  text-align: center;
  border-bottom: 1px solid #eee;
  font-size: 0.9rem;
  vertical-align: middle;
  transition: background-color 0.3s ease, color 0.3s ease;
}

tbody tr:hover td {
  background: #e3f2fd;
  color: #222;
}

button {
  background: #4364F7;
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  user-select: none;
  box-shadow: 0 2px 6px rgba(67, 100, 247, 0.3);
  font-size: 0.85rem;
}

button:hover:not(:disabled) {
  background: #2a43c1;
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(67, 100, 247, 0.4);
}

button:disabled {
  background: #ccc;
  cursor: not-allowed;
  box-shadow: none;
}

.green {
  color: #dc3545;
  font-weight: 700;
  animation: flashUp 0.5s ease;
}

.red {
  color: #007bff;
  font-weight: 700;
  animation: flashDown 0.5s ease;
}

@keyframes flashUp {
  from { background: rgba(255, 200, 200, 0.5); }
  to { background: transparent; }
}

@keyframes flashDown {
  from { background: rgba(200, 220, 255, 0.5); }
  to { background: transparent; }
}

#eventBox {
  margin-top: 25px;
  padding: 18px 25px;
  background: linear-gradient(90deg, #e9f0ff, #f5f9ff);
  border-left: 5px solid #4364F7;
  font-size: 1.1rem;
  font-weight: 600;
  color: #2a3a8f;
  border-radius: 6px;
  min-height: 48px;
  user-select: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  animation: popInEvent 0.5s ease;
}

@keyframes popInEvent {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.chart-container {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  gap: 2px;
  height: 25px;
  width: 100px;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.6);
  padding: 2px;
  border-radius: 4px;
  box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.05);
}

.bar {
  width: 8px;
  border-radius: 2px 2px 0 0;
  transition: height 0.3s ease;
}

.bar.up {
  background-color: #dc3545;
}

.bar.down {
  background-color: #007bff;
}

.inventory-item {
  background: white;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: transform 0.3s ease;
}

.inventory-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.inventory-full {
  background: rgba(255, 107, 107, 0.1) !important;
  border: 2px solid rgba(255, 107, 107, 0.3);
}

.stock-info {
  flex: 1;
}

.stock-name {
  font-weight: 700;
  font-size: 1rem;
  color: #333;
}

.stock-category {
  font-size: 0.85rem;
  color: #666;
  margin-top: 2px;
}

.use-btn {
  background: #28a745;
  padding: 8px 16px;
}

.use-btn:hover:not(:disabled) {
  background: #1e7e34;
}

#rankingContainer {
  display: none;
  animation: fadeInRanking 0.6s ease;
}

@keyframes fadeInRanking {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.gacha-result {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  z-index: 1000;
  text-align: center;
  min-width: 300px;
  animation: popIn 0.5s ease;
}

@keyframes popIn {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

.gacha-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}

/* ê±°ë˜ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
.trade-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
}

.trade-modal {
  background: white;
  border-radius: 15px;
  padding: 30px;
  max-width: 90%;
  max-height: 90%;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  animation: tradeModalIn 0.3s ease;
}

@keyframes tradeModalIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

.online-users-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.user-card {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 10px;
  padding: 15px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.user-card:hover {
  border-color: #4364F7;
  background: #e3f2fd;
  transform: translateY(-2px);
}

.user-card img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  margin-bottom: 10px;
  border: 2px solid #4364F7;
}

/* ê±°ë˜ ì¸í„°í˜ì´ìŠ¤ */
.trade-interface {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 30px;
  max-width: 1000px;
  margin: 0 auto;
}

.trade-side {
  background: #f8f9fa;
  border-radius: 10px;
  padding: 20px;
  min-height: 400px;
}

.trade-side h3 {
  text-align: center;
  margin-bottom: 20px;
  color: #333;
}

.trade-items {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
  max-height: 300px;
  overflow-y: auto;
}

.trade-item {
  background: white;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 10px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.8rem;
}

.trade-item:hover {
  border-color: #4364F7;
  transform: scale(1.05);
}

.trade-item.selected {
  border-color: #28a745;
  background: #d4edda;
}

.trade-offer {
  border: 2px dashed #ccc;
  min-height: 100px;
  border-radius: 8px;
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  padding: 10px;
  background: white;
}

.trade-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  gap: 20px;
}

.trade-status {
  text-align: center;
  padding: 15px;
  border-radius: 8px;
  font-weight: 600;
  margin-bottom: 20px;
}

.trade-status.waiting {
  background: #fff3cd;
  color: #856404;
}

.trade-status.ready {
  background: #d4edda;
  color: #155724;
}

.trade-actions {
  display: flex;
  gap: 10px;
}

.accept-btn {
  background: #28a745;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
}

.accept-btn:hover {
  background: #218838;
}

.decline-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
}

.decline-btn:hover {
  background: #c82333;
}

.free-ticket-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(45deg, #00c851, #007e33);
  color: white;
  padding: 15px 20px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0, 200, 81, 0.4);
  z-index: 1001;
  animation: slideInNotification 0.5s ease, fadeOutNotification 0.5s ease 2.5s forwards;
  font-weight: 700;
}

@keyframes slideInNotification {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeOutNotification {
  to { opacity: 0; transform: translateX(100%); }
}

/* ê±°ë˜ ìš”ì²­ ì•Œë¦¼ */
.trade-request-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: linear-gradient(45deg, #ff6b35, #f7931e);
  color: white;
  padding: 15px 20px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
  z-index: 1002;
  animation: slideInNotification 0.5s ease;
  font-weight: 700;
  max-width: 300px;
}

/* ë“±ê¸‰ë³„ ë°°ê²½ ìƒ‰ìƒ */
.rarity-common { background: linear-gradient(135deg, #f8f9fa, #e9ecef); }
.rarity-rare { background: linear-gradient(135deg, #cce5ff, #b3d9ff); }
.rarity-very-rare { background: linear-gradient(135deg, #d4edda, #c3e6cb); }
.rarity-extremely-rare { background: linear-gradient(135deg, #fff3cd, #ffeaa7); }
.rarity-amazing { 
  background: linear-gradient(135deg, #f8d7da, #f5c6cb);
}
.rarity-legendary { 
  background: linear-gradient(135deg, #e2e3ff, #d1ecf1);
}
.rarity-very-legendary { 
  background: linear-gradient(135deg, #ffe4e1, #ffcccb);
}

.special-giant { color: #ff6b35; font-weight: 900; }
.special-tiny { color: #74b9ff; font-weight: 900; }
.special-always-up { color: #00b894; font-weight: 900; }

.rarity-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-right: 5px;
}

.rarity-common .rarity-badge { background: #6c757d; color: white; }
.rarity-rare .rarity-badge { background: #007bff; color: white; }
.rarity-very-rare .rarity-badge { background: #28a745; color: white; }
.rarity-extremely-rare .rarity-badge { background: #ffc107; color: black; }
.rarity-amazing .rarity-badge { background: #dc3545; color: white; }
.rarity-legendary .rarity-badge { background: #6f42c1; color: white; }
.rarity-very-legendary .rarity-badge { background: #fd7e14; color: white; }

.special-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-right: 5px;
}

.special-giant .special-badge { background: #ff6b35; color: white; }
.special-tiny .special-badge { background: #74b9ff; color: white; }
.special-always-up .special-badge { background: #00b894; color: white; }

.modal-close {
  float: right;
  font-size: 28px;
  font-weight: bold;
  line-height: 1;
  color: #000;
  text-decoration: none;
  cursor: pointer;
  margin-left: 10px;
}

.modal-close:hover {
  color: #999;
}
  </style>
</head>
<body>
  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="loginScreen" class="login-container">
    <div id="app">
      <div class="login-title">ì£¼ì‹ ì‹œë®¬ë ˆì´í„° ë½‘ê¸° ì‹œìŠ¤í…œ</div>
      <div class="login-subtitle">ê±°ë˜ í…ŒìŠ¤íŠ¸ì¤‘(ì‘ë™X)</div>
      <button class="google-login-btn" onclick="signInWithGoogle()">
        <span>ğŸ”</span>
        Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
      </button>
    </div>
  </div>

  <!-- ë©”ì¸ ê²Œì„ í™”ë©´ -->
  <div id="gameScreen" style="display: none;">
    <div id="app">
      <!-- ì‚¬ìš©ì ì •ë³´ -->
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="" alt="ì‚¬ìš©ì ì•„ë°”íƒ€">
        <span id="userName" class="user-name"></span>
        <button class="logout-btn" onclick="signOut()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>

      <h1>ì£¼ì‹ ì‹œë®¬ë ˆì´í„° ë½‘ê¸° ì‹œìŠ¤í…œ (Made By ë²”ì„œ) Ver 4.0 - Trading Edition</h1>
      
      <div id="timer">
        <div>ë‹¤ìŒ ì£¼ê°€ ê°±ì‹ ê¹Œì§€: <span id="timerSeconds">10</span>ì´ˆ</div>
        <div>ë‹¤ìŒ ë½‘ê¸°ê¶Œ ì§€ê¸‰ê¹Œì§€: <span id="ticketTimer">60</span>ì´ˆ</div>
      </div>
      
      <div class="main-controls">
        <div class="capital-display">
          í˜„ì¬ ìë³¸ê¸ˆ: <span id="capital">100,000</span> ì›
        </div>
        <div class="ticket-display">
           ë½‘ê¸°ê¶Œ(ìµœëŒ€7ì¥): <span id="freeTickets">1</span>ê°œ
        </div>
        <button class="trade-btn" onclick="openTradeModal()">ê±°ë˜í•˜ê¸° í…ŒìŠ¤íŠ¸ì¤‘</button>
        <button id="toggleRankingBtn">ğŸ† ë­í‚¹ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°</button>
      </div>

      <div class="gacha-container">
        <button id="gachaBtn">ë½‘ê¸° (ë½‘ê¸°ê¶Œ 1ê°œ ì‚¬ìš©)</button>
      </div>

      <div class="sections-container">
        <div class="active-stocks">
          <div class="section-title">-í™œì„± ì£¼ì‹-</div>
          <table id="activeStocksTable" style="display: none;">
            <thead>
              <tr>
                <th>ì£¼ì‹ëª…</th>
                <th>ë¶„ì•¼</th>
                <th>í˜„ì¬ê°€</th>
                <th>ë³€ë™ë¥ (%)</th>
                <th>ë³€ë™ì•¡</th>
                <th>ë‚¨ì€ ë³€ë™</th>
                <th>ì°¨íŠ¸</th>
              </tr>
            </thead>
            <tbody id="activeStockTableBody"></tbody>
          </table>
          <div id="noActiveStocks" style="text-align: center; color: #666; padding: 40px;">
            í™œì„±í™”ëœ ì£¼ì‹ì´ ì—†ìŠµë‹ˆë‹¤.<br>
            ì¸ë²¤í† ë¦¬ì—ì„œ ì£¼ì‹ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”!
          </div>
        </div>

        <div class="inventory">
          <div class="inventory-header">
            <div class="section-title" style="margin: 0;">ì¸ë²¤í† ë¦¬</div>
            <div class="inventory-count">
              <span id="inventoryCount">0</span> / 9
            </div>
          </div>
          <div id="inventoryContainer">
            <div style="text-align: center; color: #666; padding: 40px;">
              ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.<br>
              ë½‘ê¸°ë¥¼ í•´ë³´ì„¸ìš”!
            </div>
          </div>
        </div>
      </div>

      <div id="eventBox">ê²Œì„ì„ ì‹œì‘í•´ë³´ì„¸ìš”! 20ì´ˆë§ˆë‹¤ ë½‘ê¸°ê¶Œì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>

    <hr id="outerHr" style="display: none;">

    <div id="rankingContainer" style="margin-top:30px; text-align: left;">
      <hr>
      <div id="ranking" style="max-width: 500px; margin-top: 15px;"></div>
    </div>
  </div>

  <script>
const firebaseConfig = {
  apiKey: "AIzaSyCAl-FzExIh2HVMLXuol5HwgPSXTbqZGNk",
  authDomain: "stockgameserver-1.firebaseapp.com",
  databaseURL: "https://stockgameserver-1-default-rtdb.firebaseio.com",
  projectId: "stockgameserver-1",
  storageBucket: "stockgameserver-1.firebasestorage.app",
  messagingSenderId: "233612874090",
  appId: "1:233612874090:web:ac09f5336c7ae09fb9d513",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// ì „ì—­ ë³€ìˆ˜
let currentUser = null;
let capital = 100000;
let inventory = [];
let activeStocks = [];
let freeTickets = 2;
let ticketTimerSeconds = 20;
let onlineUsers = {};
let currentTradeRequest = null;
let currentTrade = null;

// Google ë¡œê·¸ì¸ ì„¤ì •
const provider = new firebase.auth.GoogleAuthProvider();

// ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
auth.onAuthStateChanged((user) => {
  if (user) {
    currentUser = user;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('gameScreen').style.display = 'block';
    
    // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
    document.getElementById('userName').textContent = user.displayName;
    document.getElementById('userAvatar').src = user.photoURL;
    
    // ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
    loadUserData();
    // ì˜¨ë¼ì¸ ìƒíƒœ ì„¤ì •
    setUserOnline();
    // ì˜¨ë¼ì¸ ì‚¬ìš©ì ëª©ë¡ ê°ì§€
    watchOnlineUsers();
    // ê±°ë˜ ìš”ì²­ ê°ì§€
    watchTradeRequests();
    
    
    // ê²Œì„ ë¡œì§ ì‹œì‘
    initializeGame();
  } else {
    currentUser = null;
    document.getElementById('loginScreen').style.display = 'block';
    document.getElementById('gameScreen').style.display = 'none';
  }
});

// Google ë¡œê·¸ì¸
function signInWithGoogle() {
  auth.signInWithPopup(provider).catch((error) => {
    console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
    alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  });
}

// ë¡œê·¸ì•„ì›ƒ
function signOut() {
  // ì˜¤í”„ë¼ì¸ ìƒíƒœë¡œ ë³€ê²½
  if (currentUser) {
    db.ref(`onlineUsers/${currentUser.uid}`).remove();
  }
  
  auth.signOut().catch((error) => {
    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
  });
}

// ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
function loadUserData() {
  const userRef = db.ref(`users/${currentUser.uid}`);
  userRef.once('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      capital = data.capital || 100000;
      inventory = data.inventory || [];
      freeTickets = data.freeTickets || 1;
      activeStocks = data.activeStocks || [];
      
      updateUI();
    }
  });
}

// ì‚¬ìš©ì ë°ì´í„° ì €ì¥
function saveUserData() {
  if (!currentUser) return;
  
  const userRef = db.ref(`users/${currentUser.uid}`);
  userRef.set({
    name: currentUser.displayName,
    photoURL: currentUser.photoURL,
    capital: capital,
    inventory: inventory,
    freeTickets: freeTickets,
    activeStocks: activeStocks,
    lastSaved: Date.now()
  });
}

// ì˜¨ë¼ì¸ ìƒíƒœ ì„¤ì •
function setUserOnline() {
  const userOnlineRef = db.ref(`onlineUsers/${currentUser.uid}`);
  const userInfo = {
    name: currentUser.displayName,
    photoURL: currentUser.photoURL,
    lastSeen: Date.now()
  };
  
  userOnlineRef.set(userInfo);
  
  // ì—°ê²°ì´ ëŠì–´ì¡Œì„ ë•Œ ìë™ìœ¼ë¡œ ì œê±°
  userOnlineRef.onDisconnect().remove();
  
  // ì£¼ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
  setInterval(() => {
    if (currentUser) {
      userOnlineRef.update({ lastSeen: Date.now() });
    }
  }, 30000); // 30ì´ˆë§ˆë‹¤
}

// ì˜¨ë¼ì¸ ì‚¬ìš©ì ëª©ë¡ ê°ì§€
function watchOnlineUsers() {
  db.ref('onlineUsers').on('value', (snapshot) => {
    onlineUsers = snapshot.val() || {};
    
    // 5ë¶„ ì´ìƒ ë¹„í™œì„±ì¸ ì‚¬ìš©ì ì œê±°
    const fiveMinutesAgo = Date.now() - 5 * 60 * 1000;
    for (const [uid, user] of Object.entries(onlineUsers)) {
      if (user.lastSeen < fiveMinutesAgo) {
        db.ref(`onlineUsers/${uid}`).remove();
      }
    }
  });
}

function watchOtherInventory(otherUserId) {
  const otherInventoryRef = db.ref(`users/${otherUserId}/inventory`);
  otherInventoryRef.on('value', snapshot => {
    const otherInventory = snapshot.val() || [];
    const container = document.getElementById('otherInventory');
    if (container) {
      container.innerHTML = getTradeInventoryHTML(otherInventory, true);
    }
  });
}

// ê±°ë˜ ìš”ì²­ ê°ì§€
function watchTradeRequests() {
  const requestRef = db.ref(`tradeRequests/${currentUser.uid}`);
  requestRef.on('child_added', (snapshot) => {
    const request = snapshot.val();
    showTradeRequestNotification(request, snapshot.key);
  });
}

// ê±°ë˜ ëª¨ë‹¬ ì—´ê¸°
function openTradeModal() {
  const modal = document.createElement('div');
  modal.className = 'trade-overlay';
  modal.innerHTML = `
    <div class="trade-modal">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ì˜¨ë¼ì¸ ì‚¬ìš©ì</h2>
        <span class="modal-close" onclick="closeTradeModal()">&times;</span>
      </div>
      <div class="online-users-list" id="onlineUsersList">
        ${getOnlineUsersHTML()}
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// ì˜¨ë¼ì¸ ì‚¬ìš©ì HTML ìƒì„±
function getOnlineUsersHTML() {
  const users = Object.entries(onlineUsers).filter(([uid, user]) => uid !== currentUser.uid);
  
  if (users.length === 0) {
    return '<div style="grid-column: 1/-1; text-align: center; color: #666;">í˜„ì¬ ì˜¨ë¼ì¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  }
  
  return users.map(([uid, user]) => `
    <div class="user-card" onclick="sendTradeRequest('${uid}')">
      <img src="${user.photoURL}" alt="${user.name}">
      <div>${user.name}</div>
      <div style="font-size: 0.8rem; color: #666;">ì˜¨ë¼ì¸</div>
    </div>
  `).join('');
}

// ê±°ë˜ ëª¨ë‹¬ ë‹«ê¸°
function closeTradeModal() {
  document.querySelector('.trade-overlay')?.remove();
}

// ê±°ë˜ ìš”ì²­ ë³´ë‚´ê¸°
// ê±°ë˜ ìš”ì²­ ë³´ë‚´ê¸°
// ê±°ë˜ ìš”ì²­ ë³´ë‚´ê¸°
function sendTradeRequest(targetUserId) {
  const tradeRequest = {
    from: currentUser.uid,
    fromName: currentUser.displayName,
    fromPhoto: currentUser.photoURL,
    timestamp: Date.now()
  };
  
  db.ref(`tradeRequests/${targetUserId}/${currentUser.uid}`).set(tradeRequest);
  
  closeTradeModal();
  alert('ê±°ë˜ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!');
}

function selectTradeItem(itemId) {
  const item = inventory.find(i => i.id == itemId);
  if (!item || !currentTrade) return;

  // ë‚´ ì˜¤í¼ì— ì¶”ê°€
  const offerRef = db.ref(`trades/${currentTrade.id}/participants/${currentUser.uid}/offer`);
  offerRef.child(itemId).set(item);

  // UI ì—…ë°ì´íŠ¸
  const myOffer = document.getElementById('myOffer');
  if (myOffer) {
    const rarityName = rarityInfo[item.rarity].name;
    const specialName = specialInfo[item.special].name;
    const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;

    const offerElement = document.createElement('div');
    offerElement.className = `trade-item ${rarityInfo[item.rarity].class}`;
    offerElement.style.cssText = 'flex: 0 0 auto; width: 80px; height: 80px; font-size: 0.7rem;';
    offerElement.innerHTML = `
      <div style="font-weight: 600;">${displayName}</div>
      <div>${item.name}</div>
    `;
    myOffer.appendChild(offerElement);
  }
}

// ê±°ë˜ ìš”ì²­ ì•Œë¦¼ í‘œì‹œ
function showTradeRequestNotification(request, requestId) {
  const notification = document.createElement('div');
  notification.className = 'trade-request-notification';
  notification.innerHTML = `
    <div>ğŸ’¼ ê±°ë˜ ìš”ì²­</div>
    <div>${request.fromName}ë‹˜ì´ ê±°ë˜ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤</div>
    <div style="margin-top: 10px;">
      <button onclick="acceptTradeRequest('${request.from}', '${requestId}')" 
              style="background: #28a745; margin-right: 10px;">ìˆ˜ë½</button>
      <button onclick="declineTradeRequest('${requestId}')" 
              style="background: #dc3545;">ê±°ì ˆ</button>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // 30ì´ˆ í›„ ìë™ ì œê±°
  setTimeout(() => {
    notification.remove();
  }, 30000);
}

// ê±°ë˜ ìš”ì²­ ìˆ˜ë½
function acceptTradeRequest(fromUserId, requestId) {
  // ê±°ë˜ ì„¸ì…˜ ìƒì„±
  const tradeId = `${currentUser.uid}_${fromUserId}_${Date.now()}`;
  const tradeData = {
    participants: {
      [currentUser.uid]: {
        name: currentUser.displayName,
        photo: currentUser.photoURL,
        offer: {},
       
      },
      [fromUserId]: {
        name: onlineUsers[fromUserId].name,
        photo: onlineUsers[fromUserId].photoURL,
        offer: {},
        // ì—¬ê¸°ì„œ readyë¥¼ trueë¡œ ì„¤ì •
      
      }
    },
    status: 'active',
    createdAt: Date.now()
  };
  
  db.ref(`trades/${tradeId}`).set(tradeData).then(() => {
    // ìš”ì²­ìì—ê²Œ ê±°ë˜ ì‹œì‘ ì•Œë¦¼
    db.ref(`tradeNotifications/${fromUserId}`).push({
      type: 'trade_started',
      tradeId: tradeId,
      partnerName: currentUser.displayName,
      timestamp: Date.now()
    });
    
    // ê±°ë˜ ìš”ì²­ ì œê±°
    db.ref(`tradeRequests/${currentUser.uid}/${requestId}`).remove();
    
    // ìˆ˜ë½ì(í˜„ì¬ ì‚¬ìš©ì)ì˜ ê±°ë˜ ì¸í„°í˜ì´ìŠ¤ ì—´ê¸°
    openTradeInterface(tradeId, fromUserId);
    
    // ì•Œë¦¼ ì œê±°
    document.querySelector('.trade-request-notification')?.remove();
  });
}

// ê±°ë˜ ì•Œë¦¼ ê°ì§€ ì¶”ê°€ (watchTradeRequests í•¨ìˆ˜ì— ì¶”ê°€)
function watchTradeRequests() {
  const requestRef = db.ref(`tradeRequests/${currentUser.uid}`);
  requestRef.on('child_added', (snapshot) => {
    const request = snapshot.val();
    showTradeRequestNotification(request, snapshot.key);
  });
  
  // ê±°ë˜ ì‹œì‘ ì•Œë¦¼ ê°ì§€ ì¶”ê°€
  const notificationRef = db.ref(`tradeNotifications/${currentUser.uid}`);
  notificationRef.on('child_added', (snapshot) => {
    const notification = snapshot.val();
    if (notification.type === 'trade_started') {
      // ì•Œë¦¼ ì œê±°
      snapshot.ref.remove();
      
      // ê±°ë˜ UI ì—´ê¸° (ìš”ì²­ììš©)
      const otherUserId = Object.keys(onlineUsers).find(uid => 
        onlineUsers[uid].name === notification.partnerName && uid !== currentUser.uid
      );
      
      if (otherUserId) {
        openTradeInterface(notification.tradeId, otherUserId);
      }
    }
  });


  // ìƒëŒ€ë°© ì¤€ë¹„ ìƒíƒœ
  const otherReadyStatus = document.getElementById('otherReadyStatus');
  if (otherReadyStatus) {
    if (otherData.ready) {
      otherReadyStatus.textContent = 'ì¤€ë¹„ ì™„ë£Œ!';
      otherReadyStatus.style.background = '#d4edda';
      otherReadyStatus.style.color = '#155724';
    } else {
      otherReadyStatus.textContent = 'ì¤€ë¹„ ëŒ€ê¸° ì¤‘';
      otherReadyStatus.style.background = '#f8f9fa';
      otherReadyStatus.style.color = '#666';
    }
  }

  // ê±°ë˜ ì‹¤í–‰ ë²„íŠ¼
  const executeBtn = document.getElementById('executeBtn');
  const tradeStatus = document.getElementById('tradeStatus');
  if (executeBtn && tradeStatus) {
    const bothReady = myData.ready && otherData.ready;
    executeBtn.disabled = !bothReady;

    if (bothReady) {
      tradeStatus.className = 'trade-status ready';
      tradeStatus.textContent = 'ê±°ë˜ ì¤€ë¹„ ì™„ë£Œ! ê±°ë˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.';
    } else {
      tradeStatus.className = 'trade-status waiting';
      if (!myData.ready && !otherData.ready) {
        tradeStatus.textContent = 'ì–‘ìª½ ëª¨ë‘ ì¤€ë¹„ê°€ í•„ìš”í•©ë‹ˆë‹¤.';
      } else if (!myData.ready) {
        tradeStatus.textContent = 'ë‹¹ì‹ ì˜ ì¤€ë¹„ê°€ í•„ìš”í•©ë‹ˆë‹¤.';
      } else {
        tradeStatus.textContent = 'ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
      }
    }
  }
}






// ê±°ë˜ ì¸í„°í˜ì´ìŠ¤ ì—´ê¸° (ê°œì„ ëœ ë²„ì „)
function openTradeInterface(tradeId, otherUserId) {
  currentTrade = { id: tradeId, otherUser: otherUserId };
  
  // ê¸°ì¡´ ê±°ë˜ ì¸í„°í˜ì´ìŠ¤ê°€ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
  closeTradeInterface();
  
  const modal = document.createElement('div');
  modal.className = 'trade-overlay';
  modal.innerHTML = `
    <div class="trade-modal" style="max-width: 1200px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ê±°ë˜</h2>
        <span class="modal-close" onclick="closeTradeInterface()">&times;</span>
      </div>
      
      <div class="trade-interface">
        <!-- ë‚´ ìª½ -->
        <div class="trade-side">
          <h3>${currentUser.displayName} (ë‚˜)</h3>
          <div style="margin-bottom: 15px;">ë‚´ ì¸ë²¤í† ë¦¬:</div>
          <div class="trade-items" id="myInventory">
            ${getTradeInventoryHTML(inventory)}
          </div>
          <div style="margin-bottom: 10px;">ë‚´ ì œì•ˆ:</div>
          <div class="trade-offer" id="myOffer"></div>
          <button onclick="toggleReady()" id="myReadyBtn" style="width: 100%; margin-top: 10px;">
            ì¤€ë¹„ ì™„ë£Œ
          </button>
        </div>
        
        <!-- ì¤‘ì•™ ì»¨íŠ¸ë¡¤ -->
        <div class="trade-controls">
          <div class="trade-status waiting" id="tradeStatus">
            ê±°ë˜ ìƒëŒ€ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
          </div>
          <div class="trade-actions">
            <button class="accept-btn" onclick="executeTrade()" id="executeBtn" disabled>
              ê±°ë˜ ì‹¤í–‰
            </button>
            <button class="decline-btn" onclick="cancelTrade()">
              ê±°ë˜ ì·¨ì†Œ
            </button>
          </div>
        </div>
        
        <!-- ìƒëŒ€ë°© ìª½ -->
        <div class="trade-side">
          <h3 id="otherUserName">ìƒëŒ€ë°©</h3>
          <div style="margin-bottom: 15px;">ìƒëŒ€ë°© ì¸ë²¤í† ë¦¬:</div>
          <div class="trade-items" id="otherInventory">
            ë¡œë”© ì¤‘...
          </div>
          <div style="margin-bottom: 10px;">ìƒëŒ€ë°© ì œì•ˆ:</div>
          <div class="trade-offer" id="otherOffer"></div>
          <div id="otherReadyStatus" style="text-align: center; margin-top: 10px; padding: 10px; border-radius: 6px; background: #f8f9fa;">
            ì¤€ë¹„ ëŒ€ê¸° ì¤‘
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // ê±°ë˜ ë°ì´í„° ê°ì§€ ì‹œì‘
  watchTrade(tradeId);
  watchOtherInventory(otherUserId);

  // ë‚´/ìƒëŒ€ ì œì•ˆ ì‹¤ì‹œê°„ ê°ì§€
  db.ref(`trades/${tradeId}/participants/${currentUser.uid}/offer`)
    .on("value", snapshot => renderMyOffer(snapshot.val() || {}));

  db.ref(`trades/${tradeId}/participants/${otherUserId}/offer`)
    .on("value", snapshot => renderOtherOffer(snapshot.val() || {}));
}


// ìƒëŒ€ë°© ì¸ë²¤í† ë¦¬ ë¡œë“œ í•¨ìˆ˜ ì¶”ê°€
function loadOtherUserInventory(otherUserId) {
  db.ref(`users/${otherUserId}/inventory`).once('value', (snapshot) => {
    const otherInventory = snapshot.val() || [];
    const otherInventoryContainer = document.getElementById('otherInventory');
    
    if (otherInventoryContainer) {
      otherInventoryContainer.innerHTML = getTradeInventoryHTML(otherInventory, true);
    }
  });
}

// ê±°ë˜ ì¸ë²¤í† ë¦¬ HTML ìƒì„± (ì½ê¸° ì „ìš© ì˜µì…˜ ì¶”ê°€)
function getTradeInventoryHTML(items, readOnly = false) {
  if (!items || items.length === 0) {
    return '<div style="grid-column: 1/-1; text-align: center; color: #666;">ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>';
  }
  
  return items.map(item => {
    const rarityName = rarityInfo[item.rarity].name;
    const specialName = specialInfo[item.special].name;
    const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;
    
    const clickHandler = readOnly ? '' : `onclick="selectTradeItem(${item.id})"`;
    const dataAttribute = readOnly ? '' : `data-item-id="${item.id}"`;
    
    return `
      <div class="trade-item ${rarityInfo[item.rarity].class}" 
           ${clickHandler} 
           ${dataAttribute}
           style="${readOnly ? 'cursor: default;' : ''}">
        <div style="font-weight: 600; font-size: 0.7rem;">${displayName}</div>
        <div style="font-size: 0.8rem;">${item.name}</div>
        <div style="font-size: 0.7rem; color: #666;">${formatNumber(item.basePrice)}ì›</div>
      </div>
    `;
  }).join('');
}

// ê±°ë˜ ë°ì´í„° ê°ì§€ (ê°œì„ ëœ ë²„ì „)
function watchTrade(tradeId) {
  // ê¸°ì¡´ ê°ì§€ ì¤‘ë‹¨
  if (currentTrade && currentTrade.watcher) {
    currentTrade.watcher.off();
  }
  
  const tradeRef = db.ref(`trades/${tradeId}`);
  
  // currentTrade ê°ì²´ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ì´ˆê¸°í™”
  if (!currentTrade) {
    currentTrade = {};
  }
  
  currentTrade.watcher = tradeRef;
  currentTrade.prevTradeId = tradeId;
  
  tradeRef.on('value', (snapshot) => {
    const tradeData = snapshot.val();
    if (!tradeData) {
      // ê±°ë˜ê°€ ì·¨ì†Œë¨
      alert('ê±°ë˜ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeTradeInterface();
      return;
    }
    
    updateTradeInterface(tradeData);
  });
}

// ê±°ë˜ ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
function updateTradeInterface(tradeData) {
  if (!currentTrade) return;
  
  const participants = tradeData.participants;
  const otherUserId = currentTrade.otherUser;
  const otherUser = participants[otherUserId];
  const myData = participants[currentUser.uid];
  
  if (!otherUser || !myData) return;
  
  // ìƒëŒ€ë°© ì •ë³´ ì—…ë°ì´íŠ¸
  const otherUserNameElement = document.getElementById('otherUserName');
  if (otherUserNameElement) {
    otherUserNameElement.textContent = otherUser.name;
  }
  
  // ìƒëŒ€ë°© ì œì•ˆ ì—…ë°ì´íŠ¸
  const otherOffer = document.getElementById('otherOffer');
  if (otherOffer) {
    otherOffer.innerHTML = '';
    
    if (otherUser.offer) {
      Object.values(otherUser.offer).forEach(item => {
        const rarityName = rarityInfo[item.rarity].name;
        const specialName = specialInfo[item.special].name;
        const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;
        
        const offerElement = document.createElement('div');
        offerElement.className = `trade-item ${rarityInfo[item.rarity].class}`;
        offerElement.style.cssText = 'flex: 0 0 auto; width: 80px; height: 80px; font-size: 0.7rem;';
        offerElement.innerHTML = `
          <div style="font-weight: 600;">${displayName}</div>
          <div>${item.name}</div>
        `;
        
        otherOffer.appendChild(offerElement);
      });
    }
  }
  
  // ìƒëŒ€ë°© ì¤€ë¹„ ìƒíƒœ ì—…ë°ì´íŠ¸
  const otherReadyStatus = document.getElementById('otherReadyStatus');
  if (otherReadyStatus) {
    if (otherUser.ready) {
      otherReadyStatus.textContent = 'ì¤€ë¹„ ì™„ë£Œ!';
      otherReadyStatus.style.background = '#d4edda';
      otherReadyStatus.style.color = '#155724';
    } else {
      otherReadyStatus.textContent = 'ì¤€ë¹„ ëŒ€ê¸° ì¤‘';
      otherReadyStatus.style.background = '#f8f9fa';
      otherReadyStatus.style.color = '#666';
    }
  }
  
  // ë‚´ ì¤€ë¹„ ìƒíƒœ ë™ê¸°í™” (ë‹¤ë¥¸ ì°½ì—ì„œ ë³€ê²½ëœ ê²½ìš°)
  const myReadyBtn = document.getElementById('myReadyBtn');
  if (myReadyBtn && myData.ready !== undefined) {
    if (myData.ready) {
      myReadyBtn.textContent = 'ì¤€ë¹„ ì·¨ì†Œ';
      myReadyBtn.style.background = '#28a745';
    } else {
      myReadyBtn.textContent = 'ì¤€ë¹„ ì™„ë£Œ';
      myReadyBtn.style.background = '#4364F7';
    }
  }
  
  // ê±°ë˜ ì‹¤í–‰ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  const executeBtn = document.getElementById('executeBtn');
  const tradeStatus = document.getElementById('tradeStatus');
  
  if (executeBtn && tradeStatus) {
    const myReady = myData.ready;
    const bothReady = myReady && otherUser.ready;
    
    executeBtn.disabled = !bothReady;
    
    if (bothReady) {
      tradeStatus.className = 'trade-status ready';
      tradeStatus.textContent = 'ê±°ë˜ ì¤€ë¹„ ì™„ë£Œ! ê±°ë˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.';
    } else {
      tradeStatus.className = 'trade-status waiting';
      if (!myReady && !otherUser.ready) {
        tradeStatus.textContent = 'ì–‘ìª½ ëª¨ë‘ ì¤€ë¹„ê°€ í•„ìš”í•©ë‹ˆë‹¤.';
      } else if (!myReady) {
        tradeStatus.textContent = 'ë‹¹ì‹ ì˜ ì¤€ë¹„ê°€ í•„ìš”í•©ë‹ˆë‹¤.';
      } else {
        tradeStatus.textContent = 'ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
      }
    }
  }
}

// ê±°ë˜ ì‹¤í–‰ (ê°œì„ ëœ ë²„ì „)
function executeTrade() {
  if (!currentTrade) return;
  
  // ê±°ë˜ ì‹¤í–‰ ì¤‘ ì¤‘ë³µ ë°©ì§€

  
  db.ref(`trades/${currentTrade.id}`).once('value', (snapshot) => {
    const tradeData = snapshot.val();
    if (!tradeData) {
      alert('ê±°ë˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      closeTradeInterface();
      return;
    }
    
    const participants = tradeData.participants;
    const myOffer = participants[currentUser.uid].offer || {};
    const otherOffer = participants[currentTrade.otherUser].offer || {};
    
    // ì–‘ìª½ ëª¨ë‘ ì¤€ë¹„ ìƒíƒœì¸ì§€ ë‹¤ì‹œ í™•ì¸

    
    // ê±°ë˜ ì‹¤í–‰
    // ë‚´ê°€ ì£¼ëŠ” ì•„ì´í…œë“¤ ì œê±°
    Object.keys(myOffer).forEach(itemId => {
      const index = inventory.findIndex(item => item.id == itemId);
      if (index !== -1) {
        inventory.splice(index, 1);
      }
    });
    
    // ìƒëŒ€ë°©ì´ ì£¼ëŠ” ì•„ì´í…œë“¤ ë°›ê¸°
    Object.values(otherOffer).forEach(item => {
      inventory.push({
        ...item,
        id: Date.now() + Math.random() // ìƒˆë¡œìš´ ID ìƒì„±
      });
    });
    
    // ë°ì´í„° ì €ì¥
    saveUserData();
    renderInventory();

    // ê±°ë˜ ì„¸ì…˜ ì‚­ì œ
    db.ref(`trades/${currentTrade.id}`).remove();
    alert('ê±°ë˜ ì™„ë£Œ!')
    
    // UI ì—…ë°ì´íŠ¸
    renderInventory();
    
    alert('ê±°ë˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    closeTradeInterface();
  });
}

// ê±°ë˜ ì¸í„°í˜ì´ìŠ¤ ë‹«ê¸° (ê°œì„ ëœ ë²„ì „)
function closeTradeInterface() {
  // ê°ì§€ ì¤‘ë‹¨
  if (currentTrade && currentTrade.watcher) {
    currentTrade.watcher.off();
  }
  
  currentTrade = null;
  document.querySelector('.trade-overlay')?.remove();
}

// ë½‘ê¸° ê°€ëŠ¥í•œ ì£¼ì‹ ëª©ë¡
const availableStocks = [
  // ì‹í’ˆê´€ë ¨ (8ê°œ)
  { name: "ë¡¯ë°ì¹ ì„±", category: "ì‹í’ˆ", basePrice: 10000 },
  { name: "ì˜¤ëšœê¸°", category: "ì‹í’ˆ", basePrice: 50000 },
  { name: "ë†ì‹¬", category: "ì‹í’ˆ", basePrice: 70000 },
  { name: "CJì œì¼ì œë‹¹", category: "ì‹í’ˆ", basePrice: 95000 },
  { name: "ëŒ€ìƒ", category: "ì‹í’ˆ", basePrice: 60000 },
  { name: "ë§¤ì¼ìœ ì—…", category: "ì‹í’ˆ", basePrice: 55000 },
  { name: "ë¹™ê·¸ë ˆ", category: "ì‹í’ˆ", basePrice: 40000 },
  { name: "í’€ë¬´ì›", category: "ì‹í’ˆ", basePrice: 45000 },

  // ì „ì/ë°˜ë„ì²´ê´€ë ¨ (8ê°œ)
  { name: "ì‚¼ì„±ì „ì", category: "ì „ì/ë°˜ë„ì²´", basePrice: 100000 },
  { name: "SKí•˜ì´ë‹‰ìŠ¤", category: "ì „ì/ë°˜ë„ì²´", basePrice: 90000 },
  { name: "LGì „ì", category: "ì „ì/ë°˜ë„ì²´", basePrice: 80000 },
  { name: "ì‚¼ì„±SDI", category: "ì „ì/ë°˜ë„ì²´", basePrice: 120000 },
  { name: "LGë””ìŠ¤í”Œë ˆì´", category: "ì „ì/ë°˜ë„ì²´", basePrice: 60000 },
  { name: "DBí•˜ì´í…", category: "ì „ì/ë°˜ë„ì²´", basePrice: 70000 },
  { name: "í•œë¯¸ë°˜ë„ì²´", category: "ì „ì/ë°˜ë„ì²´", basePrice: 65000 },
  { name: "ê³ ì˜", category: "ì „ì/ë°˜ë„ì²´", basePrice: 50000 },

  // ë³´í—˜ê´€ë ¨ (8ê°œ)
  { name: "ì‚¼ì„±ìƒëª…", category: "ë³´í—˜", basePrice: 120000 },
  { name: "í•œí™”ìƒëª…", category: "ë³´í—˜", basePrice: 85000 },
  { name: "êµë³´ìƒëª…", category: "ë³´í—˜", basePrice: 70000 },
  { name: "í˜„ëŒ€í•´ìƒ", category: "ë³´í—˜", basePrice: 80000 },
  { name: "DBì†í•´ë³´í—˜", category: "ë³´í—˜", basePrice: 75000 },
  { name: "ë©”ë¦¬ì¸ í™”ì¬", category: "ë³´í—˜", basePrice: 82000 },
  { name: "í¥êµ­ìƒëª…", category: "ë³´í—˜", basePrice: 60000 },
  { name: "KBì†í•´ë³´í—˜", category: "ë³´í—˜", basePrice: 90000 },
];

// ë“±ê¸‰ ì •ë³´
const rarityInfo = {
  common: { name: "í‰ë²”í•œ", probability: 40, bonusChanges: 0, class: "rarity-common" },
  rare: { name: "í¬ê·€í•œ", probability: 25, bonusChanges: 6, class: "rarity-rare" },
  veryRare: { name: "ë§¤ìš° í¬ê·€í•œ", probability: 15, bonusChanges: 12, class: "rarity-very-rare" },
  extremelyRare: { name: "ì—„ì²­ë‚˜ê²Œ í¬ê·€í•œ", probability: 10, bonusChanges: 18, class: "rarity-extremely-rare" },
  amazing: { name: "ì •ë§ ë†€ëë„ë¡ í¬ê·€í•œ", probability: 6, bonusChanges: 24, class: "rarity-amazing" },
  legendary: { name: "ì „ì„¤ì ì¸", probability: 3, bonusChanges: 30, class: "rarity-legendary" },
  veryLegendary: { name: "ë§¤ìš° ì „ì„¤ì ì¸", probability: 1, bonusChanges: 36, class: "rarity-very-legendary" }
};

// íŠ¹ë³„í•œ ì†ì„± ì •ë³´
const specialInfo = {
  none: { name: "", probability: 91, class: "" },
  giant: { name: "ê±°ëŒ€í•œ", probability: 3, class: "special-giant" },
  tiny: { name: "ì¡°ê·¸ë§ˆí•œ", probability: 3, class: "special-tiny" },
  alwaysUp: { name: "íŠ¹ë³„í•œ", probability: 3, class: "special-always-up" }
};

const MAX_INVENTORY_SIZE = 9;

const capitalElem = document.getElementById("capital");
const eventBox = document.getElementById("eventBox");
const timerSecondsElem = document.getElementById("timerSeconds");
const ticketTimerElem = document.getElementById("ticketTimer");
const gachaBtn = document.getElementById("gachaBtn");
const freeTicketsElem = document.getElementById("freeTickets");
const inventoryContainer = document.getElementById("inventoryContainer");
const inventoryCountElem = document.getElementById("inventoryCount");
const activeStockTableBody = document.getElementById("activeStockTableBody");
const activeStocksTable = document.getElementById("activeStocksTable");
const noActiveStocks = document.getElementById("noActiveStocks");

function formatNumber(num) {
  return num.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
}

function randomPercent(min, max) {
  return Math.random() * (max - min) + min;
}

function getCustomRandomChange() {
  const rand = Math.random() * 100;
  let percent = 0;

  if (rand < 10) {
    percent = randomPercent(12, 20) * -1; // 10% ê¸‰ë½
  } else if (rand < 22) {
    percent = randomPercent(6, 10) * -1; // 12% ì¤‘ê°„ í•˜ë½
  } else if (rand < 35) {
    percent = randomPercent(2, 5) * -1; // 13% ì†Œí­ í•˜ë½
  } else if (rand < 60) {
    percent = randomPercent(1, 4); // 25% ì†Œí­ ìƒìŠ¹
  } else if (rand < 85) {
    percent = randomPercent(5, 8); // 25% ì¤‘ê°„ ìƒìŠ¹
  } else {
    percent = randomPercent(9, 15); // 15% ê¸‰ë“±
  }

  return percent;
}

// ë“±ê¸‰ ê²°ì • í•¨ìˆ˜
function determineRarity() {
  const rand = Math.random() * 100;
  let current = 0;
  
  for (const [key, info] of Object.entries(rarityInfo)) {
    current += info.probability;
    if (rand < current) {
      return key;
    }
  }
  return 'common';
}

// íŠ¹ë³„í•œ ì†ì„± ê²°ì • í•¨ìˆ˜
function determineSpecial() {
  const rand = Math.random() * 100;
  let current = 0;
  
  for (const [key, info] of Object.entries(specialInfo)) {
    current += info.probability;
    if (rand < current) {
      return key;
    }
  }
  return 'none';
}

// UI ì—…ë°ì´íŠ¸
function updateUI() {
  updateCapital();
  updateFreeTickets();
  renderInventory();
  renderActiveStocks();
  updateButtons();
}

// ë½‘ê¸°ê¶Œ ì—…ë°ì´íŠ¸
function updateFreeTickets() {
  freeTicketsElem.textContent = freeTickets;
}

// ë½‘ê¸°ê¶Œ ì•Œë¦¼
function showFreeTicketNotification() {
  const notification = document.createElement('div');
  notification.className = 'free-ticket-notification';
  notification.innerHTML = 'ğŸ‰ ë½‘ê¸°ê¶Œ íšë“!';
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// ë½‘ê¸° ê¸°ëŠ¥
function doGacha() {
  if (inventory.length >= MAX_INVENTORY_SIZE) {
    alert("ì¸ë²¤í† ë¦¬ê°€ ê°€ë“ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 9ê°œ)");
    return;
  }

  if (freeTickets <= 0) {
    alert("ë½‘ê¸°ê¶Œì´ ì—†ìŠµë‹ˆë‹¤! 1ë¶„ë§ˆë‹¤ ë½‘ê¸°ê¶Œì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  freeTickets--;
  
  const randomStock = availableStocks[Math.floor(Math.random() * availableStocks.length)];
  const rarity = determineRarity();
  const special = determineSpecial();
  
  let basePrice = randomStock.basePrice;
  
  // íŠ¹ë³„í•œ ì†ì„±ì— ë”°ë¥¸ ê°€ê²© ì¡°ì •
  if (special === 'giant') {
    basePrice *= 10;
  } else if (special === 'tiny') {
    basePrice = Math.floor(basePrice / 10);
  }
  
  const newStock = {
    id: Date.now(),
    name: randomStock.name,
    category: randomStock.category,
    basePrice: basePrice,
    rarity: rarity,
    special: special
  };
  
  inventory.push(newStock);
  
  showGachaResult(newStock);
  updateFreeTickets();
  renderInventory();
  updateButtons();
  saveUserData(); // ë°ì´í„° ì €ì¥
}

// ë½‘ê¸° ê²°ê³¼ í‘œì‹œ
function showGachaResult(stock) {
  const overlay = document.createElement('div');
  overlay.className = 'gacha-overlay';
  
  const rarityName = rarityInfo[stock.rarity].name;
  const specialName = specialInfo[stock.special].name;
  const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;
  
  const result = document.createElement('div');
  result.className = `gacha-result ${rarityInfo[stock.rarity].class} ${specialInfo[stock.special].class}`;
  result.innerHTML = `
    <h2>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
    <div style="font-size: 1.2rem; font-weight: 700; color: #333; margin: 20px 0;">
      <span class="rarity-badge">${displayName}</span>
      <br>
      ${stock.name}
    </div>
    <div style="color: #666; margin-bottom: 20px;">
      ë¶„ì•¼: ${stock.category}<br>
      ê¸°ë³¸ê°€: ${formatNumber(stock.basePrice)}ì›<br>
      ë³€ë™ íšŸìˆ˜: ${6 + rarityInfo[stock.rarity].bonusChanges}íšŒ
    </div>
    <button onclick="closeGachaResult()" style="background: #28a745; padding: 10px 20px;">í™•ì¸</button>
  `;
  
  document.body.appendChild(overlay);
  document.body.appendChild(result);
}

function closeGachaResult() {
  document.querySelector('.gacha-overlay')?.remove();
  document.querySelector('.gacha-result')?.remove();
}

// ì£¼ì‹ ì‚¬ìš©í•˜ê¸° (ì¸ë²¤í† ë¦¬ â†’ í™œì„± ì£¼ì‹)
function useStock(stockId) {
  const stockIndex = inventory.findIndex(s => s.id === stockId);
  if (stockIndex === -1) return;
  
  const stock = inventory[stockIndex];
  inventory.splice(stockIndex, 1);
  
  // í™œì„± ì£¼ì‹ìœ¼ë¡œ ì¶”ê°€
  const baseChanges = 6;
  const bonusChanges = rarityInfo[stock.rarity].bonusChanges;
  const totalChanges = baseChanges + bonusChanges;
  
  const activeStock = {
    id: stock.id,
    name: stock.name,
    category: stock.category,
    price: stock.basePrice,
    remainingChanges: totalChanges,
    changePercent: 0,
    changeAmount: 0,
    history: [],
    rarity: stock.rarity,
    special: stock.special
  };
  
  activeStocks.push(activeStock);
  
  renderInventory();
  renderActiveStocks();
  updateButtons();
  saveUserData(); // ë°ì´í„° ì €ì¥
}

// í™œì„± ì£¼ì‹ ì—…ë°ì´íŠ¸
function updateActiveStocks() {
  activeStocks.forEach((stock, index) => {
    if (stock.remainingChanges <= 0) return;
    
    let changePercent;
    
    // íŠ¹ë³„í•œ ì†ì„±: ë¬´ì¡°ê±´ ìƒìŠ¹
    if (stock.special === 'alwaysUp') {
      changePercent = Math.abs(getCustomRandomChange());
    } else {
      changePercent = getCustomRandomChange();
    }
    
    // ì´ë²¤íŠ¸ íš¨ê³¼ ì ìš©
    if (eventEffect[stock.category]) {
      changePercent += eventEffect[stock.category];
      if (changePercent < -100) changePercent = -100;
    }
    
    stock.changePercent = changePercent;
    const changeAmount = Math.floor(stock.price * (changePercent / 100));
    stock.changeAmount = changeAmount;
    
    let newPrice = stock.price + changeAmount;
    if (newPrice < 100) newPrice = 100;
    stock.price = newPrice;
    
    stock.history.push(changePercent);
    if (stock.history.length > 6) stock.history.shift();
    
    stock.remainingChanges--;
    
    // ë³€ë™ ì™„ë£Œì‹œ ìë³¸ê¸ˆì— ì¶”ê°€í•˜ê³  ì œê±°
    if (stock.remainingChanges <= 0) {
      capital += stock.price;
      setTimeout(() => {
        const currentIndex = activeStocks.findIndex(s => s.id === stock.id);
        if (currentIndex !== -1) {
          activeStocks.splice(currentIndex, 1);
          renderActiveStocks();
          updateCapital();
          saveUserData(); // ë°ì´í„° ì €ì¥
          
          const rarityName = rarityInfo[stock.rarity].name;
          const specialName = specialInfo[stock.special].name;
          const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;
          
          eventBox.textContent = `${displayName} ${stock.name}ì´ ê±°ë˜ ì™„ë£Œë˜ì–´ ${formatNumber(stock.price)}ì›ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`;
        }
      }, 2000);
    }
  });
  
  // ì´ë²¤íŠ¸ ì˜í–¥ ì´ˆê¸°í™”
  for (let key in eventEffect) {
    eventEffect[key] = 0;
  }
  
  // ë°ì´í„° ì €ì¥
  if (activeStocks.length > 0) {
    saveUserData();
  }
}

function renderMyOffer(offerData) {
  const myOffer = document.getElementById('myOffer');
  if (!myOffer) return;
  myOffer.innerHTML = '';

  Object.values(offerData).forEach(item => {
    const rarityName = rarityInfo[item.rarity].name;
    const specialName = specialInfo[item.special].name;
    const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;

    const offerElement = document.createElement('div');
    offerElement.className = `trade-item ${rarityInfo[item.rarity].class}`;
    offerElement.style.cssText = 'flex: 0 0 auto; width: 80px; height: 80px; font-size: 0.7rem;';
    offerElement.innerHTML = `
      <div style="font-weight: 600;">${displayName}</div>
      <div>${item.name}</div>
    `;
    myOffer.appendChild(offerElement);
  });
}

function renderOtherOffer(offerData) {
  const otherOffer = document.getElementById('otherOffer');
  if (!otherOffer) return;
  otherOffer.innerHTML = '';

  Object.values(offerData).forEach(item => {
    const rarityName = rarityInfo[item.rarity].name;
    const specialName = specialInfo[item.special].name;
    const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;

    const offerElement = document.createElement('div');
    offerElement.className = `trade-item ${rarityInfo[item.rarity].class}`;
    offerElement.style.cssText = 'flex: 0 0 auto; width: 80px; height: 80px; font-size: 0.7rem;';
    offerElement.innerHTML = `
      <div style="font-weight: 600;">${displayName}</div>
      <div>${item.name}</div>
    `;
    otherOffer.appendChild(offerElement);
  });
}

// ì¸ë²¤í† ë¦¬ ë Œë”ë§
function renderInventory() {
  if (!inventoryCountElem || !inventoryContainer) return;
  
  inventoryCountElem.textContent = inventory.length;
  
  if (inventory.length === 0) {
    inventoryContainer.innerHTML = `
      <div style="text-align: center; color: #666; padding: 40px;">
        ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.<br>
        ë½‘ê¸°ë¥¼ í•´ë³´ì„¸ìš”!
      </div>
    `;
    return;
  }
  
  const isInventoryFull = inventory.length >= MAX_INVENTORY_SIZE;
  
  inventoryContainer.innerHTML = inventory.map(stock => {
    const rarityName = rarityInfo[stock.rarity].name;
    const specialName = specialInfo[stock.special].name;
    const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;
    const totalChanges = 6 + rarityInfo[stock.rarity].bonusChanges;
    
    return `
      <div class="inventory-item ${rarityInfo[stock.rarity].class} ${specialInfo[stock.special].class} ${isInventoryFull ? 'inventory-full' : ''}">
        <div class="stock-info">
          <div class="stock-name">
            <span class="rarity-badge">${displayName}</span>
            ${specialName && specialName !== displayName ? `<span class="special-badge">${specialName}</span>` : ''}
            ${stock.name}
          </div>
          <div class="stock-category">
            ${stock.category} | ê¸°ë³¸ê°€: ${formatNumber(stock.basePrice)}ì› | ë³€ë™: ${totalChanges}íšŒ
          </div>
        </div>
        <button class="use-btn" onclick="useStock(${stock.id})">ì‚¬ìš©í•˜ê¸°</button>
      </div>
    `;
  }).join('');
  
  // ì¸ë²¤í† ë¦¬ê°€ ê°€ë“ ì°¬ ê²½ìš° ê²½ê³  ë©”ì‹œì§€
  if (isInventoryFull) {
    inventoryContainer.innerHTML += `
      <div style="text-align: center; color: #ff6b6b; font-weight: 600; padding: 10px; background: rgba(255, 107, 107, 0.1); border-radius: 8px; margin-top: 10px;">
        âš ï¸ ì¸ë²¤í† ë¦¬ê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (${inventory.length}/${MAX_INVENTORY_SIZE})
      </div>
    `;
  }
}

// í™œì„± ì£¼ì‹ ë Œë”ë§
function renderActiveStocks() {
  if (!activeStockTableBody || !activeStocksTable || !noActiveStocks) return;
  
  if (activeStocks.length === 0) {
    activeStocksTable.style.display = 'none';
    noActiveStocks.style.display = 'block';
    return;
  }
  
  activeStocksTable.style.display = 'table';
  noActiveStocks.style.display = 'none';
  
  activeStockTableBody.innerHTML = activeStocks.map(stock => {
    const priceStr = formatNumber(stock.price);
    const changePercentStr = stock.changePercent.toFixed(2);
    const changeAmountStr = formatNumber(stock.changeAmount);
    const changeClass = stock.changePercent > 0 ? "green" : (stock.changePercent < 0 ? "red" : "");
    
    const rarityName = rarityInfo[stock.rarity].name;
    const specialName = specialInfo[stock.special].name;
    const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;
    
    return `
      <tr class="${rarityInfo[stock.rarity].class} ${specialInfo[stock.special].class}">
        <td>
          <span class="rarity-badge">${displayName}</span><br>
          ${stock.name}
        </td>
        <td>${stock.category}</td>
        <td>${priceStr} ì›</td>
        <td class="${changeClass}">${changePercentStr}%</td>
        <td class="${changeClass}">${changeAmountStr} ì›</td>
        <td>${stock.remainingChanges}íšŒ</td>
        <td>
          <div class="chart-container">
            ${stock.history.map(pct => {
              const height = Math.min(Math.abs(pct), 20) * 1.2;
              const cls = pct > 0 ? "bar up" : "bar down";
              return `<div class="${cls}" style="height:${height}px"></div>`;
            }).join('')}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function updateCapital() {
  if (capitalElem) {
    capitalElem.textContent = formatNumber(capital);
  }
}

function updateButtons() {
  if (gachaBtn) {
    gachaBtn.disabled = freeTickets <= 0 || inventory.length >= MAX_INVENTORY_SIZE;
  }
}

// ì´ë²¤íŠ¸ ê´€ë ¨
const events = [
  {category:"ì‹í’ˆ", textUp:"ì‹í’ˆ ì•ˆì „ ê¸°ì¤€ ê°•í™”, ì‹í’ˆì£¼ ê°•ì„¸!", textDown:"ì‹í’ˆ ì›ìì¬ ê°€ê²© ê¸‰ë“±, ì‹í’ˆì£¼ ì•½ì„¸!"},
  {category:"ì „ì/ë°˜ë„ì²´", textUp:"ì „ìê³µí•™ì— ìƒˆë¡œìš´ ê¸°ìˆ  ë°œê²¬!", textDown:"ì „ìê³µí•™ í­ë°œ ìœ„í—˜ ëŒ€ë‘!"},
  {category:"ë³´í—˜", textUp:"ë³´í—˜ ì‚°ì—… ê·œì œ ì™„í™”, ë³´í—˜ì£¼ ìƒìŠ¹!", textDown:"ë³´í—˜ê¸ˆ ì§€ê¸‰ ê¸‰ì¦, ë³´í—˜ì£¼ í•˜ë½!"}
];

let eventEffect = {
  "ì‹í’ˆ": 0,
  "ì „ì/ë°˜ë„ì²´": 0,
  "ë³´í—˜": 0
};

function triggerEvent() {
  const event = events[Math.floor(Math.random() * events.length)];
  const up = Math.random() < 0.5;
  const impactPercent = 20;
  if (up) {
    eventEffect[event.category] = impactPercent;
    if (eventBox) eventBox.textContent = event.textUp;
  } else {
    eventEffect[event.category] = -impactPercent;
    if (eventBox) eventBox.textContent = event.textDown;
  }
}

// ê²Œì„ ì´ˆê¸°í™”
function initializeGame() {
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  if (gachaBtn) {
    gachaBtn.addEventListener('click', doGacha);
  }

  // ì´ë²¤íŠ¸ 3ë¶„ë§ˆë‹¤ ì‹¤í–‰ (3ë²ˆì§¸ ë³€ë™ì—ì„œë„)
  let updateCount = 0;
  const gameInterval = setInterval(() => {
    if (!currentUser) {
      clearInterval(gameInterval);
      return;
    }
    
    updateCount++;
    updateActiveStocks();
    renderActiveStocks();
    updateCapital();
    secondsLeft = 10;
    
    // 3ë²ˆì§¸ ë³€ë™ì—ì„œë„ ì´ë²¤íŠ¸ ë°œìƒ
    if (updateCount % 3 === 0) {
      triggerEvent();
    }
  }, 10000);

  // 1ì´ˆë§ˆë‹¤ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
  const timerInterval = setInterval(() => {
    if (!currentUser) {
      clearInterval(timerInterval);
      return;
    }
    
    updateTimer();
    updateTicketTimer();
  }, 1000);

  // ì´ˆê¸° ë Œë”ë§
  updateUI();
  renderRankingFromFirebase();

  // ë­í‚¹ í† ê¸€ ê¸°ëŠ¥
  const rankingContainer = document.getElementById("rankingContainer");
  const toggleBtn = document.getElementById("toggleRankingBtn");
  const outerHr = document.querySelector('body > hr');
  
  if (rankingContainer && toggleBtn) {
    if (outerHr) outerHr.style.display = "none";
    rankingContainer.style.display = "none";
    if (outerHr) outerHr.style.display = "none";
    toggleBtn.textContent = "ğŸ† ë­í‚¹ ë³´ì´ê¸°";

    toggleBtn.addEventListener("click", () => {
      const isHidden = rankingContainer.style.display === "none";

      rankingContainer.style.display = isHidden ? "block" : "none";
      if (outerHr) outerHr.style.display = isHidden ? "block" : "none";
      toggleBtn.textContent = isHidden ? "ğŸ† ë­í‚¹ ìˆ¨ê¸°ê¸°" : "ğŸ† ë­í‚¹ ë³´ì´ê¸°";
    });
  }
}

// íƒ€ì´ë¨¸ ì´ˆê¸°í™” ë° ê°±ì‹ 
let secondsLeft = 10;
function updateTimer() {
  secondsLeft--;
  if (secondsLeft < 0) {
    secondsLeft = 10;
    updateActiveStocks();
    renderActiveStocks();
    updateCapital();
  }
  if (timerSecondsElem) {
    timerSecondsElem.textContent = secondsLeft;
  }
}

// ë½‘ê¸°ê¶Œ íƒ€ì´ë¨¸
function updateTicketTimer() {
  ticketTimerSeconds--;
  if (ticketTimerSeconds <= 0) {
    ticketTimerSeconds = 19;
    freeTickets++;
  }

      if (freeTickets < 7) {
      freeTickets++;
      showFreeTicketNotification();
      updateFreeTickets();
      updateButtons();
      saveUserData(); // ë°ì´í„° ì €ì¥
    }
  
  if (ticketTimerElem) {
    ticketTimerElem.textContent = ticketTimerSeconds;
  }
}

// ë­í‚¹ ê´€ë ¨ í•¨ìˆ˜ë“¤
function getTopInvestmentCategory() {
  if (activeStocks.length === 0) return "ì—†ìŒ";
  
  const categoryTotals = {};
  activeStocks.forEach(stock => {
    const totalValue = stock.price;
    if (!categoryTotals[stock.category]) categoryTotals[stock.category] = 0;
    categoryTotals[stock.category] += totalValue;
  });

  let topCategory = "ì—†ìŒ";
  let maxValue = 0;

  for (const [category, value] of Object.entries(categoryTotals)) {
    if (value > maxValue) {
      maxValue = value;
      topCategory = category;
    }
  }

  return topCategory;
}

function saveToFirebaseRanking() {
  if (!currentUser) return;
  
  const topCategory = getTopInvestmentCategory();
  db.ref("rankings/" + currentUser.displayName.replace(/\./g, '_')).set({
    name: currentUser.displayName,
    capital: capital,
    category: topCategory,
    uid: currentUser.uid
  }, (error) => {
    if (error) {
      alert("ë“±ë¡ ì‹¤íŒ¨: " + error);
    } else {
      alert("ë­í‚¹ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }
  });
}

function renderRankingFromFirebase() {
  db.ref("rankings").orderByChild("capital").limitToLast(10).on("value", (snapshot) => {
    const data = [];
    snapshot.forEach(child => {
      data.push(child.val());
    });

    data.sort((a, b) => b.capital - a.capital);

    const rankDiv = document.getElementById("ranking");
    if (rankDiv) {
      rankDiv.innerHTML = `
        <h3 style="margin-bottom: 12px; color:#222;">ğŸ† ë­í‚¹ TOP 10</h3>
        <div style="margin-bottom: 15px;">
          <button onclick="saveToFirebaseRanking()" 
                  style="padding:8px 16px; font-size:1rem; background: #4364F7; color: white; border: none; border-radius: 6px; cursor: pointer;">
            ğŸ… ë‚´ ì ìˆ˜ ë“±ë¡í•˜ê¸°
          </button>
        </div>
        <ul style="list-style: none; padding: 0; margin: 0;">
          ${data.map((r, i) => `
            <li style="background: #f5f7ff; border-left: 4px solid #4364F7; border-radius: 6px; padding: 10px 14px; margin-bottom: 8px; color: #333; font-weight: 500;">
              <strong style="margin-right: 10px;">${i + 1}ìœ„</strong> ${r.name} â€” ğŸ’° ${formatNumber(r.capital)} ì›
              <div style="font-size: 0.9rem; color:#666;">ğŸ“Š ìµœëŒ€ íˆ¬ì ë¶„ì•¼: <strong>${r.category || "ì—†ìŒ"}</strong></div>
            </li>
          `).join("")}
        </ul>
      `;
    }
  });
}

  </script>
</body>
</html>
