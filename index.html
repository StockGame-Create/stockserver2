<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>주식 시뮬레이터 +뽑기</title>
  <style>
/* 베이스 스타일 */
body {
  background: linear-gradient(120deg, #eef2f3, #8e9eab);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 20px;
  display: flex;
  justify-content: center;
  animation: fadeInBody 1.2s ease;
}

@keyframes fadeInBody {
  from { opacity: 0; transform: scale(1.02); }
  to { opacity: 1; transform: scale(1); }
}

#app {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  padding: 30px 40px;
  width: 1200px;
  transition: box-shadow 0.4s ease, transform 0.4s ease;
}
#app:hover {
  transform: scale(1.002);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.18);
}

h1 {
  text-align: center;
  margin-bottom: 15px;
  font-weight: 700;
  letter-spacing: 1.5px;
  font-size: 2.2rem;
  background: linear-gradient(to right, #0052D4, #6FB1FC);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  color: transparent;
  display: inline-block;
}

#timer {
  text-align: center;
  font-size: 1.1rem;
  color: #555;
  margin-bottom: 20px;
  font-weight: 600;
  letter-spacing: 1px;
  background: rgba(255, 255, 255, 0.6);
  padding: 8px 16px;
  border-radius: 12px;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
}

.main-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 15px;
}

.capital-display {
  font-weight: 600;
  font-size: 1.2rem;
  color: #444;
}

.gacha-container {
  text-align: center;
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

#gachaBtn {
  background: linear-gradient(45deg, #00c851, #007e33);
  border: none;
  color: white;
  padding: 12px 24px;
  border-radius: 20px;
  cursor: pointer;
  font-weight: 700;
  font-size: 1.1rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 200, 81, 0.4);
  animation: gachaGlow 2s infinite alternate;
}

@keyframes gachaGlow {
  from { box-shadow: 0 4px 15px rgba(0, 200, 81, 0.4); }
  to { box-shadow: 0 6px 20px rgba(0, 200, 81, 0.6); }
}

#gachaBtn:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(0, 200, 81, 0.6);
}

#gachaBtn:disabled {
  background: #ccc;
  cursor: not-allowed;
  animation: none;
  box-shadow: none;
}

.ticket-display {
  font-weight: 600;
  font-size: 1rem;
  color: #28a745;
  background: rgba(40, 167, 69, 0.1);
  padding: 8px 16px;
  border-radius: 12px;
  border: 2px solid #28a745;
}

.sections-container {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
}

.active-stocks, .inventory {
  flex: 1;
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.section-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #333;
  margin-bottom: 15px;
  text-align: center;
  padding-bottom: 8px;
  border-bottom: 2px solid #4364F7;
}

.inventory-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.inventory-count {
  font-size: 1rem;
  font-weight: 600;
  color: #666;
  background: rgba(67, 100, 247, 0.1);
  padding: 4px 12px;
  border-radius: 12px;
  border: 1px solid rgba(67, 100, 247, 0.3);
}

table {
  width: 100%;
  border-collapse: collapse;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 20px;
}

thead {
  background: linear-gradient(90deg, #0052D4, #4364F7, #6FB1FC);
  color: white;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

th, td {
  padding: 10px 8px;
  text-align: center;
  border-bottom: 1px solid #eee;
  font-size: 0.9rem;
  vertical-align: middle;
  transition: background-color 0.3s ease, color 0.3s ease;
}

tbody tr:hover td {
  background: #e3f2fd;
  color: #222;
}

button {
  background: #4364F7;
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  user-select: none;
  box-shadow: 0 2px 6px rgba(67, 100, 247, 0.3);
  font-size: 0.85rem;
}

button:hover:not(:disabled) {
  background: #2a43c1;
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(67, 100, 247, 0.4);
}

button:disabled {
  background: #ccc;
  cursor: not-allowed;
  box-shadow: none;
}

.green {
  color: #dc3545;
  font-weight: 700;
  animation: flashUp 0.5s ease;
}

.red {
  color: #007bff;
  font-weight: 700;
  animation: flashDown 0.5s ease;
}

@keyframes flashUp {
  from { background: rgba(255, 200, 200, 0.5); }
  to { background: transparent; }
}

@keyframes flashDown {
  from { background: rgba(200, 220, 255, 0.5); }
  to { background: transparent; }
}

#eventBox {
  margin-top: 25px;
  padding: 18px 25px;
  background: linear-gradient(90deg, #e9f0ff, #f5f9ff);
  border-left: 5px solid #4364F7;
  font-size: 1.1rem;
  font-weight: 600;
  color: #2a3a8f;
  border-radius: 6px;
  min-height: 48px;
  user-select: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  animation: popInEvent 0.5s ease;
}

@keyframes popInEvent {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.chart-container {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  gap: 2px;
  height: 25px;
  width: 100px;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.6);
  padding: 2px;
  border-radius: 4px;
  box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.05);
}

.bar {
  width: 8px;
  border-radius: 2px 2px 0 0;
  transition: height 0.3s ease;
}

.bar.up {
  background-color: #dc3545;
}

.bar.down {
  background-color: #007bff;
}

.inventory-item {
  background: white;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: transform 0.3s ease;
}

.inventory-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.inventory-full {
  background: rgba(255, 107, 107, 0.1) !important;
  border: 2px solid rgba(255, 107, 107, 0.3);
}

.stock-info {
  flex: 1;
}

.stock-name {
  font-weight: 700;
  font-size: 1rem;
  color: #333;
}

.stock-category {
  font-size: 0.85rem;
  color: #666;
  margin-top: 2px;
}

.use-btn {
  background: #28a745;
  padding: 8px 16px;
}

.use-btn:hover:not(:disabled) {
  background: #1e7e34;
}

#rankingContainer {
  display: none;
  animation: fadeInRanking 0.6s ease;
}

@keyframes fadeInRanking {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.gacha-result {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  z-index: 1000;
  text-align: center;
  min-width: 300px;
  animation: popIn 0.5s ease;
}

@keyframes popIn {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

.gacha-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}

.free-ticket-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(45deg, #00c851, #007e33);
  color: white;
  padding: 15px 20px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0, 200, 81, 0.4);
  z-index: 1001;
  animation: slideInNotification 0.5s ease, fadeOutNotification 0.5s ease 2.5s forwards;
  font-weight: 700;
}

@keyframes slideInNotification {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeOutNotification {
  to { opacity: 0; transform: translateX(100%); }
}

/* 등급별 배경 색상 */
.rarity-common { background: linear-gradient(135deg, #f8f9fa, #e9ecef); }
.rarity-rare { background: linear-gradient(135deg, #cce5ff, #b3d9ff); }
.rarity-very-rare { background: linear-gradient(135deg, #d4edda, #c3e6cb); }
.rarity-extremely-rare { background: linear-gradient(135deg, #fff3cd, #ffeaa7); }
.rarity-amazing { 
  background: linear-gradient(135deg, #f8d7da, #f5c6cb);

}
.rarity-legendary { 
  background: linear-gradient(135deg, #e2e3ff, #d1ecf1);

}
.rarity-very-legendary { 
  background: linear-gradient(135deg, #ffe4e1, #ffcccb);

}

/* 특별한 이펙트 */


@keyframes sparkle {
  0%, 100% { transform: rotate(0deg) scale(1); opacity: 0.5; }
  50% { transform: rotate(180deg) scale(1.1); opacity: 0.8; }
}

.special-giant { color: #ff6b35; font-weight: 900; }
.special-tiny { color: #74b9ff; font-weight: 900; }
.special-always-up { color: #00b894; font-weight: 900; }

.rarity-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-right: 5px;
}

.rarity-common .rarity-badge { background: #6c757d; color: white; }
.rarity-rare .rarity-badge { background: #007bff; color: white; }
.rarity-very-rare .rarity-badge { background: #28a745; color: white; }
.rarity-extremely-rare .rarity-badge { background: #ffc107; color: black; }
.rarity-amazing .rarity-badge { background: #dc3545; color: white; }
.rarity-legendary .rarity-badge { background: #6f42c1; color: white; }
.rarity-very-legendary .rarity-badge { background: #fd7e14; color: white; }

.special-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-right: 5px;
}

.special-giant .special-badge { background: #ff6b35; color: white; }
.special-tiny .special-badge { background: #74b9ff; color: white; }
.special-always-up .special-badge { background: #00b894; color: white; }
  </style>
</head>
<body>
  <div id="app">
    <h1>주식 시뮬레이터 뽑기 시스템 (Made By 범서) Ver 3.01A</h1>
    <div id="timer">
      <div>다음 주가 갱신까지: <span id="timerSeconds">10</span>초</div>
      <div>다음 뽑기권 지급까지: <span id="ticketTimer">60</span>초</div>
    </div>
    
    <div class="main-controls">
      <div class="capital-display">
        현재 자본금: <span id="capital">100,000</span> 원
      </div>
      <div class="ticket-display">
         뽑기권: <span id="freeTickets">1</span>개
      </div>
      <button id="toggleRankingBtn">🏆 랭킹 보이기/숨기기</button>
    </div>

    <div class="gacha-container">
      <button id="gachaBtn">뽑기 (뽑기권 1개 사용)</button>
    </div>

    <div class="sections-container">
      <div class="active-stocks">
        <div class="section-title">-활성 주식-</div>
        <table id="activeStocksTable" style="display: none;">
          <thead>
            <tr>
              <th>주식명</th>
              <th>분야</th>
              <th>현재가</th>
              <th>변동률(%)</th>
              <th>변동액</th>
              <th>남은 변동</th>
              <th>차트</th>
            </tr>
          </thead>
          <tbody id="activeStockTableBody"></tbody>
        </table>
        <div id="noActiveStocks" style="text-align: center; color: #666; padding: 40px;">
          활성화된 주식이 없습니다.<br>
          인벤토리에서 주식을 사용해보세요!
        </div>
      </div>

      <div class="inventory">
        <div class="inventory-header">
          <div class="section-title" style="margin: 0;">인벤토리</div>
          <div class="inventory-count">
            <span id="inventoryCount">0</span> / 9
          </div>
        </div>
        <div id="inventoryContainer">
          <div style="text-align: center; color: #666; padding: 40px;">
            인벤토리가 비어있습니다.<br>
            뽑기를 해보세요!
          </div>
        </div>
      </div>
    </div>

    <div id="eventBox">게임을 시작해보세요! 20초마다 뽑기권을 받을 수 있습니다.</div>
  </div>

  <hr id="outerHr" style="display: none;">

  <div id="rankingContainer" style="margin-top:30px; text-align: left;">
    <hr>
    <div>
      <input
        type="text"
        id="username"
        placeholder="이름 입력"
        style="padding:6px 12px; border-radius:6px; border:1px solid #ccc; font-size:1rem;" />
      <button
        onclick="saveRanking()"
        style="padding:6px 16px; font-size:1rem; margin-left:10px;">🏅 랭킹 등록</button>
    </div>
    <div id="ranking" style="max-width: 500px; margin-top: 15px;"></div>
  </div>

  <script>
const firebaseConfig = {
  apiKey: "AIzaSyCAl-FzExIh2HVMLXuol5HwgPSXTbqZGNk",
  authDomain: "stockgameserver-1.firebaseapp.com",
  databaseURL: "https://stockgameserver-1-default-rtdb.firebaseio.com",
  projectId: "stockgameserver-1",
  storageBucket: "stockgameserver-1.firebasestorage.app",
  messagingSenderId: "233612874090",
  appId: "1:233612874090:web:ac09f5336c7ae09fb9d513",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 뽑기 가능한 주식 목록
const availableStocks = [
  // 식품관련 (8개)
  { name: "롯데칠성", category: "식품", basePrice: 10000 },
  { name: "오뚜기", category: "식품", basePrice: 50000 },
  { name: "농심", category: "식품", basePrice: 70000 },
  { name: "CJ제일제당", category: "식품", basePrice: 95000 },
  { name: "대상", category: "식품", basePrice: 60000 },
  { name: "매일유업", category: "식품", basePrice: 55000 },
  { name: "빙그레", category: "식품", basePrice: 40000 },
  { name: "풀무원", category: "식품", basePrice: 45000 },

  // 전자/반도체관련 (8개)
  { name: "삼성전자", category: "전자/반도체", basePrice: 100000 },
  { name: "SK하이닉스", category: "전자/반도체", basePrice: 90000 },
  { name: "LG전자", category: "전자/반도체", basePrice: 80000 },
  { name: "삼성SDI", category: "전자/반도체", basePrice: 120000 },
  { name: "LG디스플레이", category: "전자/반도체", basePrice: 60000 },
  { name: "DB하이텍", category: "전자/반도체", basePrice: 70000 },
  { name: "한미반도체", category: "전자/반도체", basePrice: 65000 },
  { name: "고영", category: "전자/반도체", basePrice: 50000 },

  // 보험관련 (8개)
  { name: "삼성생명", category: "보험", basePrice: 120000 },
  { name: "한화생명", category: "보험", basePrice: 85000 },
  { name: "교보생명", category: "보험", basePrice: 70000 },
  { name: "현대해상", category: "보험", basePrice: 80000 },
  { name: "DB손해보험", category: "보험", basePrice: 75000 },
  { name: "메리츠화재", category: "보험", basePrice: 82000 },
  { name: "흥국생명", category: "보험", basePrice: 60000 },
  { name: "KB손해보험", category: "보험", basePrice: 90000 },
];

// 등급 정보
const rarityInfo = {
  common: { name: "평범한", probability: 40, bonusChanges: 0, class: "rarity-common" },
  rare: { name: "희귀한", probability: 25, bonusChanges: 6, class: "rarity-rare" },
  veryRare: { name: "매우 희귀한", probability: 15, bonusChanges: 12, class: "rarity-very-rare" },
  extremelyRare: { name: "엄청나게 희귀한", probability: 10, bonusChanges: 18, class: "rarity-extremely-rare" },
  amazing: { name: "정말 놀랍도록 희귀한", probability: 6, bonusChanges: 24, class: "rarity-amazing" },
  legendary: { name: "전설적인", probability: 3, bonusChanges: 30, class: "rarity-legendary" },
  veryLegendary: { name: "매우 전설적인", probability: 1, bonusChanges: 36, class: "rarity-very-legendary" }
};

// 특별한 속성 정보
const specialInfo = {
  none: { name: "", probability: 91, class: "" },
  giant: { name: "거대한", probability: 3, class: "special-giant" },
  tiny: { name: "조그마한", probability: 3, class: "special-tiny" },
  alwaysUp: { name: "특별한", probability: 3, class: "special-always-up" }
};

let capital = 100000;
let inventory = [];
let activeStocks = [];
let freeTickets = 1; // 시작시 1개 지급
let ticketTimerSeconds = 60; // 1분 뽑기권 타이머

const MAX_INVENTORY_SIZE = 9;

const capitalElem = document.getElementById("capital");
const eventBox = document.getElementById("eventBox");
const timerSecondsElem = document.getElementById("timerSeconds");
const ticketTimerElem = document.getElementById("ticketTimer");
const gachaBtn = document.getElementById("gachaBtn");
const freeTicketsElem = document.getElementById("freeTickets");
const inventoryContainer = document.getElementById("inventoryContainer");
const inventoryCountElem = document.getElementById("inventoryCount");
const activeStockTableBody = document.getElementById("activeStockTableBody");
const activeStocksTable = document.getElementById("activeStocksTable");
const noActiveStocks = document.getElementById("noActiveStocks");

function formatNumber(num) {
  return num.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
}

function randomPercent(min, max) {
  return Math.random() * (max - min) + min;
}

function getCustomRandomChange() {
  const rand = Math.random() * 100;
  let percent = 0;

  if (rand < 10) {
    percent = randomPercent(12, 20) * -1; // 10% 급락
  } else if (rand < 22) {
    percent = randomPercent(6, 10) * -1; // 12% 중간 하락
  } else if (rand < 35) {
    percent = randomPercent(2, 5) * -1; // 13% 소폭 하락
  } else if (rand < 60) {
    percent = randomPercent(1, 4); // 25% 소폭 상승
  } else if (rand < 85) {
    percent = randomPercent(5, 8); // 25% 중간 상승
  } else {
    percent = randomPercent(9, 15); // 15% 급등
  }

  return percent;
}

// 등급 결정 함수
function determineRarity() {
  const rand = Math.random() * 100;
  let current = 0;
  
  for (const [key, info] of Object.entries(rarityInfo)) {
    current += info.probability;
    if (rand < current) {
      return key;
    }
  }
  return 'common';
}

// 특별한 속성 결정 함수
function determineSpecial() {
  const rand = Math.random() * 100;
  let current = 0;
  
  for (const [key, info] of Object.entries(specialInfo)) {
    current += info.probability;
    if (rand < current) {
      return key;
    }
  }
  return 'none';
}

// 뽑기권 업데이트
function updateFreeTickets() {
  freeTicketsElem.textContent = freeTickets;
}

// 뽑기권 알림
function showFreeTicketNotification() {
  const notification = document.createElement('div');
  notification.className = 'free-ticket-notification';
  notification.innerHTML = '🎉 뽑기권 획득!';
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// 뽑기 기능
function doGacha() {
  if (inventory.length >= MAX_INVENTORY_SIZE) {
    alert("인벤토리가 가득찼습니다! (최대 9개)");
    return;
  }

  if (freeTickets <= 0) {
    alert("뽑기권이 없습니다! 1분마다 뽑기권을 받을 수 있습니다.");
    return;
  }

  freeTickets--;
  
  const randomStock = availableStocks[Math.floor(Math.random() * availableStocks.length)];
  const rarity = determineRarity();
  const special = determineSpecial();
  
  let basePrice = randomStock.basePrice;
  
  // 특별한 속성에 따른 가격 조정
  if (special === 'giant') {
    basePrice *= 10;
  } else if (special === 'tiny') {
    basePrice = Math.floor(basePrice / 10);
  }
  
  const newStock = {
    id: Date.now(),
    name: randomStock.name,
    category: randomStock.category,
    basePrice: basePrice,
    rarity: rarity,
    special: special
  };
  
  inventory.push(newStock);
  
  showGachaResult(newStock);
  updateFreeTickets();
  renderInventory();
  updateButtons();
}

// 뽑기 결과 표시
function showGachaResult(stock) {
  const overlay = document.createElement('div');
  overlay.className = 'gacha-overlay';
  
  const rarityName = rarityInfo[stock.rarity].name;
  const specialName = specialInfo[stock.special].name;
  const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;
  
  const result = document.createElement('div');
  result.className = `gacha-result ${rarityInfo[stock.rarity].class} ${specialInfo[stock.special].class}`;
  result.innerHTML = `
    <h2>🎉 축하합니다!</h2>
    <div style="font-size: 1.2rem; font-weight: 700; color: #333; margin: 20px 0;">
      <span class="rarity-badge">${displayName}</span>
      <br>
      ${stock.name}
    </div>
    <div style="color: #666; margin-bottom: 20px;">
      분야: ${stock.category}<br>
      기본가: ${formatNumber(stock.basePrice)}원<br>
      변동 횟수: ${6 + rarityInfo[stock.rarity].bonusChanges}회
    </div>
    <button onclick="closeGachaResult()" style="background: #28a745; padding: 10px 20px;">확인</button>
  `;
  
  document.body.appendChild(overlay);
  document.body.appendChild(result);
}

function closeGachaResult() {
  document.querySelector('.gacha-overlay')?.remove();
  document.querySelector('.gacha-result')?.remove();
}

// 주식 사용하기 (인벤토리 → 활성 주식)
function useStock(stockId) {
  const stockIndex = inventory.findIndex(s => s.id === stockId);
  if (stockIndex === -1) return;
  
  const stock = inventory[stockIndex];
  inventory.splice(stockIndex, 1);
  
  // 활성 주식으로 추가
  const baseChanges = 6;
  const bonusChanges = rarityInfo[stock.rarity].bonusChanges;
  const totalChanges = baseChanges + bonusChanges;
  
  const activeStock = {
    id: stock.id,
    name: stock.name,
    category: stock.category,
    price: stock.basePrice,
    remainingChanges: totalChanges,
    changePercent: 0,
    changeAmount: 0,
    history: [],
    rarity: stock.rarity,
    special: stock.special
  };
  
  activeStocks.push(activeStock);
  
  renderInventory();
  renderActiveStocks();
  updateButtons();
}

// 활성 주식 업데이트
function updateActiveStocks() {
  activeStocks.forEach((stock, index) => {
    if (stock.remainingChanges <= 0) return;
    
    let changePercent;
    
    // 특별한 속성: 무조건 상승
    if (stock.special === 'alwaysUp') {
      changePercent = Math.abs(getCustomRandomChange());
    } else {
      changePercent = getCustomRandomChange();
    }
    
    // 이벤트 효과 적용
    if (eventEffect[stock.category]) {
      changePercent += eventEffect[stock.category];
      if (changePercent < -100) changePercent = -100;
    }
    
    stock.changePercent = changePercent;
    const changeAmount = Math.floor(stock.price * (changePercent / 100));
    stock.changeAmount = changeAmount;
    
    let newPrice = stock.price + changeAmount;
    if (newPrice < 100) newPrice = 100;
    stock.price = newPrice;
    
    stock.history.push(changePercent);
    if (stock.history.length > 6) stock.history.shift();
    
    stock.remainingChanges--;
    
    // 변동 완료시 자본금에 추가하고 제거
    if (stock.remainingChanges <= 0) {
      capital += stock.price;
      setTimeout(() => {
        const currentIndex = activeStocks.findIndex(s => s.id === stock.id);
        if (currentIndex !== -1) {
          activeStocks.splice(currentIndex, 1);
          renderActiveStocks();
          updateCapital();
          
          const rarityName = rarityInfo[stock.rarity].name;
          const specialName = specialInfo[stock.special].name;
          const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;
          
          eventBox.textContent = `${displayName} ${stock.name}이 거래 완료되어 ${formatNumber(stock.price)}원을 획득했습니다!`;
        }
      }, 2000);
    }
  });
  
  // 이벤트 영향 초기화
  for (let key in eventEffect) {
    eventEffect[key] = 0;
  }
}

// 인벤토리 렌더링
function renderInventory() {
  inventoryCountElem.textContent = inventory.length;
  
  if (inventory.length === 0) {
    inventoryContainer.innerHTML = `
      <div style="text-align: center; color: #666; padding: 40px;">
        인벤토리가 비어있습니다.<br>
        뽑기를 해보세요!
      </div>
    `;
    return;
  }
  
  const isInventoryFull = inventory.length >= MAX_INVENTORY_SIZE;
  
  inventoryContainer.innerHTML = inventory.map(stock => {
    const rarityName = rarityInfo[stock.rarity].name;
    const specialName = specialInfo[stock.special].name;
    const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;
    const totalChanges = 6 + rarityInfo[stock.rarity].bonusChanges;
    
    return `
      <div class="inventory-item ${rarityInfo[stock.rarity].class} ${specialInfo[stock.special].class} ${isInventoryFull ? 'inventory-full' : ''}">
        <div class="stock-info">
          <div class="stock-name">
            <span class="rarity-badge">${displayName}</span>
            ${specialName && specialName !== displayName ? `<span class="special-badge">${specialName}</span>` : ''}
            ${stock.name}
          </div>
          <div class="stock-category">
            ${stock.category} | 기본가: ${formatNumber(stock.basePrice)}원 | 변동: ${totalChanges}회
          </div>
        </div>
        <button class="use-btn" onclick="useStock(${stock.id})">사용하기</button>
      </div>
    `;
  }).join('');
  
  // 인벤토리가 가득 찬 경우 경고 메시지
  if (isInventoryFull) {
    inventoryContainer.innerHTML += `
      <div style="text-align: center; color: #ff6b6b; font-weight: 600; padding: 10px; background: rgba(255, 107, 107, 0.1); border-radius: 8px; margin-top: 10px;">
        ⚠️ 인벤토리가 가득 찼습니다! (${inventory.length}/${MAX_INVENTORY_SIZE})
      </div>
    `;
  }
}

// 활성 주식 렌더링
function renderActiveStocks() {
  if (activeStocks.length === 0) {
    activeStocksTable.style.display = 'none';
    noActiveStocks.style.display = 'block';
    return;
  }
  
  activeStocksTable.style.display = 'table';
  noActiveStocks.style.display = 'none';
  
  activeStockTableBody.innerHTML = activeStocks.map(stock => {
    const priceStr = formatNumber(stock.price);
    const changePercentStr = stock.changePercent.toFixed(2);
    const changeAmountStr = formatNumber(stock.changeAmount);
    const changeClass = stock.changePercent > 0 ? "green" : (stock.changePercent < 0 ? "red" : "");
    
    const rarityName = rarityInfo[stock.rarity].name;
    const specialName = specialInfo[stock.special].name;
    const displayName = specialName ? `${specialName} ${rarityName}` : rarityName;
    
    return `
      <tr class="${rarityInfo[stock.rarity].class} ${specialInfo[stock.special].class}">
        <td>
          <span class="rarity-badge">${displayName}</span><br>
          ${stock.name}
        </td>
        <td>${stock.category}</td>
        <td>${priceStr} 원</td>
        <td class="${changeClass}">${changePercentStr}%</td>
        <td class="${changeClass}">${changeAmountStr} 원</td>
        <td>${stock.remainingChanges}회</td>
        <td>
          <div class="chart-container">
            ${stock.history.map(pct => {
              const height = Math.min(Math.abs(pct), 20) * 1.2;
              const cls = pct > 0 ? "bar up" : "bar down";
              return `<div class="${cls}" style="height:${height}px"></div>`;
            }).join('')}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function updateCapital() {
  capitalElem.textContent = formatNumber(capital);
}

function updateButtons() {
  gachaBtn.disabled = freeTickets <= 0 || inventory.length >= MAX_INVENTORY_SIZE;
}

// 이벤트 관련
const events = [
  {category:"식품", textUp:"식품 안전 기준 강화, 식품주 강세!", textDown:"식품 원자재 가격 급등, 식품주 약세!"},
  {category:"전자/반도체", textUp:"전자공학에 새로운 기술 발견!", textDown:"전자공학 폭발 위험 대두!"},
  {category:"보험", textUp:"보험 산업 규제 완화, 보험주 상승!", textDown:"보험금 지급 급증, 보험주 하락!"}
];

let eventEffect = {
  "식품": 0,
  "전자/반도체": 0,
  "보험": 0
};

function triggerEvent() {
  const event = events[Math.floor(Math.random() * events.length)];
  const up = Math.random() < 0.5;
  const impactPercent = 20;
  if (up) {
    eventEffect[event.category] = impactPercent;
    eventBox.textContent = event.textUp;
  } else {
    eventEffect[event.category] = -impactPercent;
    eventBox.textContent = event.textDown;
  }
}

// 타이머 초기화 및 갱신
let secondsLeft = 10;
function updateTimer() {
  secondsLeft--;
  if (secondsLeft < 0) {
    secondsLeft = 10;
    updateActiveStocks();
    renderActiveStocks();
    updateCapital();
  }
  timerSecondsElem.textContent = secondsLeft;
}

// 뽑기권 타이머
function updateTicketTimer() {
  ticketTimerSeconds--;
  if (ticketTimerSeconds <= 0) {
    ticketTimerSeconds = 20;
    freeTickets++;
    showFreeTicketNotification();
    updateFreeTickets();
    updateButtons();
  }
  ticketTimerElem.textContent = ticketTimerSeconds;
}

// 이벤트 리스너
gachaBtn.addEventListener('click', doGacha);

// 이벤트 3분마다 실행 (3번째 변동에서도)
let updateCount = 0;
setInterval(() => {
  updateCount++;
  updateActiveStocks();
  renderActiveStocks();
  updateCapital();
  secondsLeft = 10;
  
  // 3번째 변동에서도 이벤트 발생
  if (updateCount % 3 === 0) {
    triggerEvent();
  }
}, 10000);

// 1초마다 타이머 업데이트
setInterval(() => {
  updateTimer();
  updateTicketTimer();
}, 1000);

// 초기 렌더링
renderInventory();
renderActiveStocks();
updateCapital();
updateFreeTickets();
updateButtons();
renderRankingFromFirebase(); // ← 이 줄 추가

// 랭킹 관련 함수들
function getTopInvestmentCategory() {
  if (activeStocks.length === 0) return "없음";
  
  const categoryTotals = {};
  activeStocks.forEach(stock => {
    const totalValue = stock.price;
    if (!categoryTotals[stock.category]) categoryTotals[stock.category] = 0;
    categoryTotals[stock.category] += totalValue;
  });

  let topCategory = "없음";
  let maxValue = 0;

  for (const [category, value] of Object.entries(categoryTotals)) {
    if (value > maxValue) {
      maxValue = value;
      topCategory = category;
    }
  }

  return topCategory;
}

function saveToFirebaseRanking(username) {
  const topCategory = getTopInvestmentCategory();
  db.ref("rankings/" + username).set({
    name: username,
    capital: capital,
    category: topCategory
  }, (error) => {
    if (error) {
      alert("등록 실패: " + error);
    } else {
      alert("랭킹에 등록되었습니다!");
    }
  });
}

function renderRankingFromFirebase() {
  db.ref("rankings").orderByChild("capital").limitToLast(10).on("value", (snapshot) => {
    const data = [];
    snapshot.forEach(child => {
      data.push(child.val());
    });

    data.sort((a, b) => b.capital - a.capital);

    const rankDiv = document.getElementById("ranking");
    rankDiv.innerHTML = `
      <h3 style="margin-bottom: 12px; color:#222;">🏆 랭킹 TOP 10</h3>
      <ul style="list-style: none; padding: 0; margin: 0;">
        ${data.map((r, i) => `
          <li style="background: #f5f7ff; border-left: 4px solid #4364F7; border-radius: 6px; padding: 10px 14px; margin-bottom: 8px; color: #333; font-weight: 500;">
            <strong style="margin-right: 10px;">${i + 1}위</strong> ${r.name} — 💰 ${formatNumber(r.capital)} 원
            <div style="font-size: 0.9rem; color:#666;">📊 최대 투자 분야: <strong>${r.category || "없음"}</strong></div>
          </li>
        `).join("")}
      </ul>
    `;
  });
}

function saveRanking() {
  const name = document.getElementById("username").value.trim();
  if (name === "") return alert("이름을 입력하세요!");

  if (name === "pleaseresetあ") {
    db.ref("rankings").remove();
    alert("랭킹이 초기화되었습니다.");
    return;
  }

  db.ref("rankings/" + name).once("value").then(snapshot => {
    if (snapshot.exists()) {
      alert("이미 등록된 이름입니다!");
    } else {
      saveToFirebaseRanking(name);
    }
  });
}

const rankingContainer = document.getElementById("rankingContainer");
const toggleBtn = document.getElementById("toggleRankingBtn");

const outerHr = document.querySelector('body > hr');
if (outerHr) outerHr.style.display = "none";

rankingContainer.style.display = "none";
if (outerHr) outerHr.style.display = "none";
toggleBtn.textContent = "🏆 랭킹 보이기";

toggleBtn.addEventListener("click", () => {
  const isHidden = rankingContainer.style.display === "none";

  rankingContainer.style.display = isHidden ? "block" : "none";
  if (outerHr) outerHr.style.display = isHidden ? "block" : "none";
  toggleBtn.textContent = isHidden ? "🏆 랭킹 숨기기" : "🏆 랭킹 보이기";
});

  </script>
</body>

</html>
